#!/usr/bin/env ruby
require 'yaml'
require 'commander/import'
require 'terminal-announce'
require 'robot_sweatshop/cli'
require 'robot_sweatshop/config'
require 'robot_sweatshop/create-config-directories'

program :name, 'Robot Sweatshop'
program :version, '0.4.13'
program :description, 'A lightweight, nonopinionated CI server'
program :help, 'Author', 'Justin Scott <jvscott@gmail.com>'

command :plan do |c|
  c.syntax = 'sweatshop plan <name>'
  c.description = 'Creates and edits jobs.'
  c.option '--auto', 'Create the file without opening the editor.'
  c.action do |args, options|
    options.default auto: false
    fail 'Specify a job name as the command argument.' if args.count < 1
    job_file = CLI::Job.path_for args.first
    CLI.create job_file, with_contents: CLI::Job.default
    CLI.edit job_file unless options.auto
  end
end

command :config do |c|
  c.syntax = 'sweatshop config [options]'
  c.description = 'Creates and edits the user configuration file.'
  c.option '--auto', 'Create the file without opening the editor.'
  c.action do |args, options|
    options.default auto: false
    for_scope = args.first || 'local'
    config_file = CLI::Config.path for_scope
    CLI.create config_file, with_contents: CLI::Config.default
    CLI.edit config_file unless options.auto
  end
end

command :start do |c|
  c.syntax = 'sweatshop start [options]'
  c.description = 'Start the Sweatshop.'
  c.action do |_args, options|
    CLI::Start.sweatshop
  end
end

command :stop do |c|
  c.syntax = 'sweatshop stop'
  c.description = 'Stop the Sweatshop.'
  c.action do
    Announce.info `eye stop robot_sweatshop`
  end
end

alias_command :restart, :start

command :gears do |c|
  c.syntax = 'sweatshop gears ...'
  c.description = 'See `sweatshop-gears --help`'
  c.option '--path'
  c.action do
    begin
      system "sweatshop-gears #{ARGV[1..-1].join ' '}"
    rescue Errno::ENOENT
      Announce.failure 'Sweatshop Gears not found. Run `gem install sweatshop_gears`'
    end
  end
end
