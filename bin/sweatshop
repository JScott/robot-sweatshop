#!/usr/bin/env ruby
require 'bundler/setup'
require 'yaml'
require 'commander/import'
require 'colorize'
require_relative '../lib/sweatshop/cli/common'
require_relative '../lib/sweatshop/cli/job'
require_relative '../lib/sweatshop/cli/inspect'
require_relative '../lib/sweatshop/cli/start'
require_relative '../lib/sweatshop/cli/config'
require_relative '../lib/sweatshop/config'

program :name, 'Robot Sweatshop'
program :version, '0.1.2'
program :description, 'A lightweight, unopinionated CI server'
program :help, 'Author', 'Justin Scott <jvscott@gmail.com>'

command :job do |c|
  c.syntax = 'sweatshop job <name>'
  c.description = 'Creates and edits jobs.'
  c.option '--edit', 'Manually edit the file.'
  c.option '--reset', 'Reset to factory defaults before editing.'
  c.action do |args, options|
    options.default :edit => false
    options.default :reset => false
    job_file = get_job_file for_job: args.first
    create job_file, with_contents: empty_job if options.reset
    edit job_file if options.edit
  end
end

command :audit do |c|
  c.syntax = 'sweatshop audit [job-name]'
  c.description = 'Audit job information.'
  c.action do |args|
    if args.first.nil?
      list_jobs
    else
      job_file = get_job_file for_job: args.first
      validate job_file unless job_file.nil?
    end
  end
end

command :start do |c|
  c.syntax = 'sweatshop start [options]'
  c.description = 'Start the Sweatshop.'
  c.option '--testing', 'Load the testing Eye configuration.'
  c.action do |_args, options|
    options.default :testing => false
    environment = options.testing ? 'testing' : 'production'
    start_sweatshop for_environment: environment
  end
end

command :stop do |c|
  c.syntax = 'sweatshop stop'
  c.description = 'Stop the Sweatshop.'
  c.action do
    notify :info, `eye stop robot_sweatshop`
  end
end

command :config do |c|
  c.syntax = 'sweatshop config [options]'
  c.description = 'Creates and edits the user configuration file.'
  c.option '--reset', 'Reset to factory defaults before editing.'
  c.action do |_args, options|
    options.default :reset => false
    remove_user_config if options.reset
    create_and_edit_user_config
  end
end
