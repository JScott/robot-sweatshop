#!/usr/bin/env ruby
require 'bundler/setup'
require 'sinatra'
require 'ezmq'
require 'oj'
require 'robot_sweatshop/config'

configure do
  client_settings = {
    port: configatron.conveyor_port,
    encode: -> message { Oj.dump message },
    decode: -> message { Oj.load message }
  }
  set :client, EZMQ::Client.new(client_settings)
  set :port, configatron.http_port
  set :bind, configatron.http_bind
  set :run, true
end

get '/' do
  'Everything\'s on schedule!'
end

post '/payload-for/:job_name' do
  puts "Received payload for #{params['job_name']}"
  request.body.rewind
  payload = request.body.read
  hash = {
    method: 'enqueue',
    data: {
      payload: payload,
      user_agent: request.env['HTTP_USER_AGENT'],
      job_name: params['job_name']
    }
  }
  settings.client.request hash, {}
  Oj.dump hash
end
